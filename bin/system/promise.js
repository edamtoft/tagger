define(["system/enumerable"],function(a){"use strict";function b(b){function d(a){i!==c.DONE&&(i=c.DONE,j=a,void f())}function e(a){i!==c.DONE&&(i=c.DONE,k=a,void f())}function f(){a.of(l).each(function(a){void a(k,j)})}function g(a){return window.setImmediate?void window.setImmediate(a):void window.setTimeout(a,0)}var h=this,i=c.DEFERED,j=null,k=null,l=[];this.then=function(a){return i===c.DONE?(g(function(){void a(k,j)}),h):(l.push(a),i===c.DEFERED&&(i=c.PENDING,g(function(){void b(d,e)})),h)}}var c={DEFERED:0,PENDING:1,DONE:2};return{that:function(a){return new b(a)}}});